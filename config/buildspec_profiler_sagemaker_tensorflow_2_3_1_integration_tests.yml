# Build Spec for AWS CodeBuild CI

version: 0.2
env:
  variables:
    override_smdebug_version: "true" # should we install the latest version of smdebug or use the existing version of smdebug?
    force_run_tests: "false"
phases:
  install:
    commands:
      # If we are not force running the tests, determine whether to run the tests based on the files changed in the branch compared to master.
      - if [ "$force_run_tests" = "true" ]; then run_tests="true"; else chmod +x config/check_changed_files.sh && run_tests=`./config/check_changed_files.sh tensorflow` ; fi
      - apt-get update
      - apt-get install sudo -qq -o=Dpkg::Use-Pty=0
      - sudo apt-get install unzip -qq -o=Dpkg::Use-Pty=0
      - pip install --upgrade pip==19.3.1
      - cd $CODEBUILD_SRC_DIR && chmod +x config/protoc_downloader.sh && ./config/protoc_downloader.sh && cd ..
      - pip install -q wheel==0.35.1 pyYaml==5.3.1 pytest-html==3.0.0 sagemaker==2.23.0 pre-commit==2.6.0 awscli==1.18.203
      - pip install -q pytest==6.1.2 pytest-cov==2.10.1 flaky==3.7.0 pytest-xdist==2.2.0
      - pip install -q pandas==1.1.5

  build:
    commands:
      # build pip wheel of the latest smdebug
      - cd $CODEBUILD_SRC_DIR  && python setup.py bdist_wheel --universal && pip install --force-reinstall dist/*.whl
      - echo "horovod==0.19.5" > $CODEBUILD_SRC_DIR_TESTS/tests/scripts/tf_scripts/requirements.txt  # TODO: remove after fixing https://sim.amazon.com/issues/P42199318
      - echo "tensorflow-datasets==4.0.1" >> $CODEBUILD_SRC_DIR_TESTS/tests/scripts/tf_scripts/requirements.txt
      - if [ "$override_smdebug_version" = "true" ]; then cd $CODEBUILD_SRC_DIR/dist &&  echo "./"`ls smdebug*` >> $CODEBUILD_SRC_DIR_TESTS/tests/scripts/tf_scripts/requirements.txt &&  cp smdebug*  $CODEBUILD_SRC_DIR_TESTS/tests/scripts/tf_scripts/. ; fi
      # Runs the smprofiler sagemaker integration tests
      - if [ "$run_tests" = "true" ]; then cd $CODEBUILD_SRC_DIR_TESTS  && echo "Running profiler integration tests!" && python -m pytest -n auto -v -s -W=ignore --html=$REPORT_DIR/profiler_report_analysis.html --self-contained-html tests/test_profiler_tensorflow.py ; else echo "Skipping profiler integration tests!"; fi

  post_build:
    commands:
      - if [ "$CODEBUILD_BUILD_SUCCEEDING" -eq 0 ]; then echo "ERROR BUILD FAILED " && exit 1 ; fi
      - if [ "$CODEBUILD_BUILD_SUCCEEDING" -eq 1 ]; then echo "INFO BUILD SUCCEEDED !!! " ; fi
