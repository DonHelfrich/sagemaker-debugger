- values:
  - [mnist_folder: &mnist_folder
      tests/sagemaker/scripts/mnist/,
     resnet_folder: &resnet_folder
      tests/sagemaker/scripts/resnet/,
     nmt_folder: &nmt_folder
      tests/sagemaker/scripts/nmt/,
     Enable: &Enable # enable the test case
      True,
     Disable: &Disable # disable the test case
      False,
    ]

- cpu_jobs:
  -
    - smprofiler-IT-mnist-keras-cpu-default
    - *Enable
    - *mnist_folder
    - mnist_cpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.c5.4xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
        PythonProfilingConfig: "{\"StartStep\": \"1\", \"NumSteps\": \"5\", \"ProfilerName\": \"cprofile\"}"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 1
        framework_trace_file_count: 13
        python_stats_file_count: 23
  -
    - smprofiler-IT-mnist-keras-cpu-disabled
    - *Enable
    - *mnist_folder
    - mnist_cpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.c5.4xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "False"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 0
        framework_trace_file_count: 0
        python_stats_file_count: 0
  -
    - smprofiler-IT-mnist-keras-cpu-absent
    - *Enable
    - *mnist_folder
    - mnist_cpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.c5.4xlarge
    - instance_count: 1
    - profiler_params:
    - expected_values_in_test_artifacts:
        python_trace_file_count: 0
        framework_trace_file_count: 0
        python_stats_file_count: 0
  -
    - smprofiler-IT-mnist-keras-cpu-custom
    - *Enable
    - *mnist_folder
    - mnist_cpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.c5.4xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
        PythonProfilingConfig: "{\"NumSteps\": \"3\", \"ProfilerName\": \"pyinstrument\"}"
        RotateMaxFileSizeInBytes: "12485760.34"
        RotateFileCloseIntervalInSeconds: "100.45"
        FileOpenFailThreshold: "35"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 1
        framework_trace_file_count: 11
        python_stats_file_count: 30
  -
    - smprofiler-IT-keras-resnet-cpu-hvd-multinode
    - *Disable
    - *resnet_folder
    - keras_resnet_hvd.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.c5.4xlarge
    - instance_count: 2
    - profiler_params:
        RotateMaxFileSizeInBytes: "15485760"
        RotateFileCloseIntervalInSeconds: "100"
        FileOpenFailThreshold: "35"
        ProfilerEnabled: "True"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 2
        framework_trace_file_count: 4
        python_stats_file_count: 1

- gpu_jobs:
  -
    - smprofiler-IT-single-node-multi-gpu-hvd
    - *Enable
    - *mnist_folder
    - mnist_hvd.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 12
        framework_trace_file_count: 28
        python_stats_file_count: 32
        horovod_tracefile_count: 3
  -
    - smprofiler-IT-keras-resnet-gpu-mirrored
    - *Enable
    - *resnet_folder
    - keras_resnet_mirrored.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
        RotateMaxFileSizeInBytes: "20485760"
        RotateFileCloseIntervalInSeconds: "100"
        FileOpenFailThreshold: "35"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 1
        framework_trace_file_count: 7
        python_stats_file_count: 10
  -
    - smprofiler-IT-mnist-keras-gpu-default
    - *Enable
    - *mnist_folder
    - mnist_gpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
        PythonProfilingConfig: "{\"StartStep\": \"1\", \"ProfilerName\": \"pyinstrument\"}"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 1
        framework_trace_file_count: 2
        python_stats_file_count: 8
  -
    - smprofiler-IT-mnist-keras-gpu-disabled
    - *Enable
    - *mnist_folder
    - mnist_gpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "False"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 0
        framework_trace_file_count: 0
        python_stats_file_count: 0
  -
    - smprofiler-IT-mnist-keras-gpu-absent
    - *Enable
    - *mnist_folder
    - mnist_gpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 1
    - profiler_params:
    - expected_values_in_test_artifacts:
        python_trace_file_count: 0
        framework_trace_file_count: 0
        python_stats_file_count: 0
  -
    - smprofiler-IT-mnist-keras-gpu-custom
    - *Enable
    - *mnist_folder
    - mnist_gpu.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
        PythonProfilingConfig: "{\"DurationInSeconds\": \"100\", \"ProfilerName\": \"cprofile\"}"
        RotateMaxFileSizeInBytes: "5485760"
        RotateFileCloseIntervalInSeconds: "50"
        FileOpenFailThreshold: "35"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 1
        framework_trace_file_count: 2
        python_stats_file_count: 22
  -
    - smprofiler-IT-multi-node-multi-gpu-hvd
    - *Enable
    - *mnist_folder
    - mnist_hvd.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p2.8xlarge
    - instance_count: 2
    - profiler_params:
        ProfilerEnabled: "True"
        RotateMaxFileSizeInBytes: "15485760"
        RotateFileCloseIntervalInSeconds: "100"
        FileOpenFailThreshold: "35"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 8
        framework_trace_file_count: 24
        python_stats_file_count: 64
        horovod_tracefile_count: 1
  -
    - smprofiler-IT-multi-gpu-native-tf2-nmt
    - *Disable # enable after fixing this - https://sim.amazon.com/issues/P41030156
    - *nmt_folder
    - distributed_train.py
    - AmazonSageMaker-ExecutionRole-20200205T150348
    - ml.p3.16xlarge
    - instance_count: 1
    - profiler_params:
        ProfilerEnabled: "True"
    - expected_values_in_test_artifacts:
        python_trace_file_count: 0
        framework_trace_file_count: 13
        python_stats_file_count: 1
